```{r}

knitr::opts_chunk$set(message=FALSE, warning=FALSE,echo=TRUE,error = FALSE)
library(knitr)
library(OOSAP)

```

## Prepare data

```{r PreparingData}

rawDataSaveFile <- paste0(outPrefix, '.rawData.rds')
seuratObjs <- list()
if (file.exists(rawDataSaveFile)) {
  print('resuming from file')
  seuratObjs <- readRDS(rawDataSaveFile)
} else {
  for (datasetName in names(data)) {
    print(paste0('Loading dataset: ', datasetName))
    seuratObjs[[datasetName]] <- ReadAndFilter10xData(dataDir = data[[datasetName]], datasetName = datasetName)

    print(seuratObjs[[datasetName]])
  }

  saveRDS(seuratObjs, file = rawDataSaveFile)
}

```

## Merge data

```{r MergeDatasets}

seuratObj <- NULL
saveFile <- paste0(outPrefix, '.seurat.rds')
if (file.exists(saveFile)) {
  print('resuming from file')
  seuratObj <- readRDS(saveFile)
} else {
  seuratObj <- MergeSeuratObjs(seuratObjs, metadata = data)
  saveRDS(seuratObj, file = saveFile)
  rm(seuratObjs)
}

print(seuratObj)

```

## Initial Processing

```{r InitialProcessing}

seuratObj <- ProcessSeurat1(seuratObj, variableGeneTable = paste0(outPrefix, '.variableGenes.txt'), doCellFilter = doCellFilter, saveFile = saveFile)

```

## DimRedux

```{r DimRedux}

seuratObj <- FindClustersAndDimRedux(seuratObj, dimsToUse = dimsToUse)

Find_Markers(seuratObj, resolutionToUse = resolutionToUse, outFile = paste0(outPrefix, '.markers.txt'), saveFileMarkers = paste0(outPrefix, '.markers.rds'))

```

## SingleR

```{r}

seuratObj <- RunSingleR(seuratObj = seuratObj, resultTableFile = paste0(outPrefix, '.singleR.txt'))
saveRDS(seuratObj, file = saveFile)

DimPlot_SingleRClassLabs(seuratObj, plotIndividually = T)

Tabulate_SingleRClassLabs(seuratObj, plotIndividually = T)

```

## Phenotypes

```{r}

PlotImmuneMarkers(seuratObj, reduction = 'tsne')

PlotImmuneMarkers(seuratObj, reduction = 'umap')

```

## Write Summary

```{r}

saveRDS(seuratObj, file = saveFile)
unlink(rawDataSaveFile)

WriteSummaryMetrics(seuratObj, file = paste0(outPrefix, '.summary.txt'))

SaveDimRedux(seuratObj, file = paste0(outPrefix, '.DimReduxComps.csv'))

WriteCellBarcodes(seuratObj, file = paste0(outPrefix, '.cellBarcodes.csv'))

```

## Print Session Info

```{r SessionInfo}

sessionInfo()

```

