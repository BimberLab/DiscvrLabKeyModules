```{r}

knitr::opts_chunk$set(message=FALSE, warning=FALSE,echo=TRUE,error = FALSE)
library(knitr)
library(ggplot2)
library(Seurat)
library(dplyr)

source('https://raw.githubusercontent.com/bbimber/rnaseq/master/seurat/seuratFunctions.R')

```

## Prepare data

```{r PreparingData}

saveFile <- paste0(outPrefix, '.rawData.rds')
seuratObjs <- list()
if (file.exists(saveFile)) {
  print('resuming from file')
  seuratObjs <- readRDS(saveFile)
} else {
  for (datasetName in names(data)) {
    print(paste0('Loading dataset: ', datasetName))
    seuratObjs[datasetName] <- readAndFilter10xData(data[[datasetName]], datasetName)

    print(seuratObjs[datasetName])
  }

  saveRDS(seuratObjs, file = saveFile)
}

```

## Merge data

```{r MergeDatasets}

seuratObj <- NULL
saveFile <- paste0(outPrefix, '.seurat.rds')
if (file.exists(saveFile)) {
  print('resuming from file')
  seuratObj <- readRDS(saveFile)
} else {
  seuratObj <- mergeSeuratObjs(seuratObjs, data)
  saveRDS(seuratObj, file = saveFile)
  rm(seuratObjs)
}

seuratObj

```

## Initial Processing

```{r InitialProcessing}

seuratObj <- processSeurat1(seuratObj, saveFile = saveFile)

```

## DimRedux

```{r DimRedux}

seuratObj <- findClustersAndDimRedux(seuratObj, saveFile = saveFile)

findMarkers(seuratObj, resolutionToUse, outFile = paste0(outPrefix, '.markers.txt'), saveFileMarkers = paste0(outPrefix, '.markers.rds'))

```

## Print Session Info

```{r SessionInfo}

sessionInfo()

```

