<script type="text/javascript">

    Ext4.onReady(function(){
        var webpart = <%=webpartContext%>;

        Ext4.create('Ext.panel.Panel', {
            defaults: {
                border: false
            },
            border: false,
            listeners: {
                render: function(panel){
                    LABKEY.Ajax.request({
                        url: LABKEY.ActionURL.buildURL('sequenceanalysis', 'getAnalysisToolDetails'),
                        scope: panel,
                        success: LABKEY.Utils.getCallbackWrapper(panel.onDataLoad, panel),
                        failure: LDK.Utils.getErrorCallback()
                    });
                }
            },
            onDataLoad: function(results){
                var target = this.down('#toolPanel');
                var toAdd = [{
                    html : 'Once data are imported in the system, analyses can be run.  This is analogous to the features available through Galaxy and similar tools.  The sequence ' +
                    'module is built using on LabKey Server\'s data analysis pipeline, which was originally developed for high-throughput proteomics, but has since been applied' +
                    'to other areas as well.  The Sequence Pipeline is designed to provide a flexible way to combine sequence tools together.  You can create a new pipeline by strining steps together, or save pipelines for repeated used.  ' +
                    'The following tools are currently supported, and it is possible to register additional tools.'
                }];

                var steps = [
                    {name: 'fastqProcessing', label: 'FASTQ Processing'},
                    //{referenceLibraryCreation: 'Reference Library'},
                    {name: 'alignment', label: 'Alignment'},
                    {name: 'bamPostProcessing', label: 'BAM Post-processing'},
                    {name: 'variantCalling', label: 'Variant Calling'},
                    {name: 'variantPostProcessing', label: 'Variant Post Processing'},
                    {name: 'analysis', label: 'Downstream Analysis'}
                ];

                var toolItems = [];

                Ext4.Array.forEach(steps, function(step){
                    if (results[step.name] && results[step.name].length){
                        toolItems.push({
                            style: 'padding-top: 10px;padding-bottom: 5px;',
                            colspan: 3,
                            html: '<i>' + step.label + ':</i>'
                        });

                        var tools = results[step.name];
                        LDK.Utils.sortByProperty(tools, 'label');

                        Ext4.Array.forEach(tools, function(tool){
                            toolItems = toolItems.concat([{
                                html: '- ' + tool.label
                            },{
                                xtype: 'ldk-linkbutton',
                                linkCls: 'labkey-text-link',
                                text: 'Description',
                                style: 'padding-left: 10px;',
                                toolCfg: tool,
                                handler: function(btn){
                                    Ext4.Msg.alert(btn.toolCfg.label, (btn.toolCfg.description || 'No Description Provided'));
                                }
                            },{
                                xtype: 'ldk-linkbutton',
                                linkCls: (tool.websiteURL ? 'labkey-text-link' : ''),
                                text: (tool.websiteURL ? 'View Website' : ''),
                                url: tool.websiteURL,
                                style: 'padding-left: 20px;'
                            }]);
                        }, this);
                    }
                }, this);

                toAdd.push({
                    style: 'padding-left: 10px;',
                    border: false,
                    defaults: {
                        border: false
                    },
                    layout: {
                        type: 'table',
                        columns: 3
                    },
                    items: toolItems
                });

                target.removeAll();
                target.add(toAdd);
            },
            items: [{
                itemId: 'toolPanel',
                border: false,
                defaults: {
                    border: false
                },
                items: [{
                    html: 'Loading...'
                }]
            }]
        }).render(webpart.wrapperDivId);

    });

</script>