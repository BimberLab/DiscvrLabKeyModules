<script type="text/javascript">

Ext4.onReady(function (){

    if (LABKEY.Security.currentUser.isAdmin){
        var webpart = <%=webpartContext%>;

        Ext4.define('SettingsPanel', {
            extend: 'Ext.form.Panel',
            initComponent: function(){
                Ext4.apply(this, {
                    border: false,
                    items: [{
                        html: 'This page allows site-level administration of the JBrowse module.  The JBrowse module is a wrapper around the JBrowse Genome Browser.  It is separate from JBrowse and not written by the JBrowse authors.  With the module, LabKey serves as the database and source of sequence data and tracks.  LabKey allows the user to choose genomes/tracks and create a customized JBrowse session.  In the background, this module will handle most of the configuration and prepare your sequences and tracks for viewing in JBrowse.  This module ships with all JBrowse viewer code, meaning no additional configuration is necessary.  However, for this mondule to work properly, you will need to install the JBrowse bin files, which are the scripts used to prepare input files for the browser.  Because these scripts require dependenies, and installing JBrowse is very straightforward, we recommend you <a href=""">follow the official JBrowse installation instructions here<a/>.  You only need to download JBrowse and run setup.sh.  You do not need to run or configure Apache (LabKey Server replaces the need for this).  Once installed, enter the path to the /bin folder below:' +
                            '<p></p>' +
                            '<ul>' +
                                '<li>' +
                                      'jbrowseBinDir: The path where the /bin directory from JBrowse is located.  This contains the scripts used to process flatfiles to show in JBrowse' +
                                '</li>' +
                            '</ul>',
                        border: false,
                        style: 'padding-bottom: 20px;'
                    },{
                        border: false,
                        itemId: 'settings',
                        items: [{
                            html: 'Loading...'
                        }]
                    }]
                });

                this.loadData();
                this.callParent();
            },

            loadData: function(){
                LABKEY.Ajax.request({
                    url: LABKEY.ActionURL.buildURL('jbrowse', 'getSettings', null),
                    method : 'GET',
                    scope: this,
                    failure: LDK.Utils.getErrorCallback(),
                    success: this.onLoad
                });
            },

            onLoad: function(results){
                var json = LDK.Utils.decodeHttpResponseJson(results);
                var labelWidth = 160;
                var width = 550;

                var toAdd = [];
                Ext4.each(json.configKeys, function(key){
                    toAdd.push({
                        xtype: 'textfield',
                        labelWidth: labelWidth,
                        width: width,
                        itemId: key,
                        fieldLabel: key,
                        value: json.config[key]
                    });
                }, this);

                var target = this.down('#settings');
                target.removeAll();
                target.add({
                    xtype: 'form',
                    border: false,
                    bodyStyle: 'padding: 5px;',
                    items: toAdd,
                    buttons: [{
                        text: 'Save Settings',
                        itemId: 'saveBtn',
                        handler: this.onSubmit
                    }]
                });
            },

            onSubmit: function(btn){
                var form = btn.up('form');
                var fields = form.getForm().getFields();

                var json = {};

                fields.each(function(field){
                    if (field.itemId)
                        json[field.itemId] = field.getValue();
                }, this);

                LABKEY.Ajax.request({
                    url: LABKEY.ActionURL.buildURL('jbrowse', 'setSettings', '/'),
                    method : 'POST',
                    params: json,
                    scope: this,
                    failure: LDK.Utils.getErrorCallback(),
                    success: function(response){
                        Ext4.Msg.alert('Success', 'Save Successful', function(){
                            window.location.reload();
                        });
                    }
                });
            }
        });

        Ext4.create('SettingsPanel', {}).render(webpart.wrapperDivId);
    }
});

</script>