language: java
dist: trusty
git:
  depth: 9999999
jdk:
  - openjdk13

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.m2
    - $HOME/labkey_build/
    - $HOME/site-library

install: skip
script:
  - bash ./travis.sh

before_deploy:
  - export RELEASE_NAME=`cat ${TRAVIS_BUILD_DIR}/release.txt`
  - 'echo "Release name: "${RELEASE_NAME}'
  - 'echo "Pull request: "${TRAVIS_PULL_REQUEST}'
  - cd $TRAVIS_BUILD_DIR

deploy:
  # For internal distribution
  - provider: releases
    api_key: ${GH_TOKEN}
    repo: 'bimberlabinternal/BimberLabKeyModules'
    overwrite: true
    file_glob: true
    file:
      - ./lkDist/discvr/*.gz
      - ./lkDist/prime-seq-modules/*.zip
    name: ${RELEASE_NAME}
    draft: false
    body: 'This is the latest draft build, automatically published by Travis-CI.  This is not intended as a production release.'
    skip_cleanup: true
    tag_name: 'Latest'
    on:
      all_branches: true
      condition: '$TRAVIS_BRANCH =~ ^(develop|discvr)[0-9\.\-]* AND NOT $TRAVIS_PULL_REQUEST'

  # For public releases
  - provider: releases
    api_key: ${GH_TOKEN}
    repo: 'BimberLab/DiscvrLabKeyModules'
    overwrite: true
    body: 'This release is compatible with LabKey Server version $TRAVIS_TAG.  It contains a full installer (which contains the core LabKey modules), and also a standalone ZIP with just the DISCVR modules.  The latter can be unzipped into your server externalModules or modules directories.'
    file_glob: true
    file:
      - ./lkDist/discvr/*.gz
      - ./lkDist/discvr_modules/*.zip
    name: ${TRAVIS_TAG}
    skip_cleanup: true
    on:
      tags: true